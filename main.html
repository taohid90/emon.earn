<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport" />
    <title>Ti Sports - The Unlimited Entertainment Here</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet">

<!-- আপনার পুরোনো <style> ব্লকটি ডিলিট করে নিচের সম্পূর্ণ নতুন ব্লকটি পেস্ট করুন -->

<style>
    :root {
        --primary-color: #ff4f00;
        --bg-dark: #0a0a0a;
        --card-bg: #1a1a1a;
        --font-main: 'Poppins', sans-serif;
        --accent-green: #4ade80; 
    }

    /* --- Drawer Styles --- */
    body.drawer-open {
        overflow: hidden;
    }
    #drawer-overlay {
        transition: opacity 0.3s ease-in-out;
    }
    body.drawer-open #drawer-overlay {
        display: block;
        opacity: 1;
    }
    body.drawer-open #nav-drawer {
        transform: translateX(0);
        box-shadow: 10px 0 40px rgba(0,0,0,0.5);
    }
    .drawer-link {
        display: flex;
        align-items: center;
        padding: 12px;
        gap: 1rem;
        border-radius: 8px;
        color: #d1d5db; /* text-gray-300 */
        font-weight: 500;
        transition: all 0.2s ease-in-out;
    }
    .drawer-link:hover, .drawer-link:focus {
        background-color: rgba(255, 79, 0, 0.15);
        color: var(--primary-color);
    }
    .drawer-link i {
        font-size: 1.1rem;
        text-align: center;
    }
    html { scroll-behavior: smooth; }
    body { 
        font-family: var(--font-main);
        background-color: var(--bg-dark);
        color: #f0f0f0;
        overflow-x: hidden;
    }

    /* --- Main App Shell Styles --- */
    #app-shell { display: flex; flex-direction: column; min-height: 100vh; }
    main { flex-grow: 1; padding-bottom: 80px; }
    .main-header { background: rgba(10, 10, 10, 0.7); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border-bottom: 1px solid rgba(255, 255, 255, 0.07); }
    #banner-container { height: 56.25vw; max-height: 450px; min-height: 220px; background-color: #1f1f1f; }
    .swiper-slide { display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .swiper-slide a { display: block; width: 100%; height: 100%; position: relative; }
    .swiper-slide a::after { content: ''; position: absolute; left: 0; bottom: 0; width: 100%; height: 60%; background: linear-gradient(to top, rgba(10, 10, 10, 0.9), transparent); z-index: 1; }
    .swiper-slide img { width: 100%; height: 100%; object-fit: cover; }
    .swiper-pagination-bullet-active { background-color: var(--primary-color); }
    .banner-play-icon { position: absolute; bottom: 20px; right: 20px; z-index: 2; width: 50px; height: 50px; background-color: rgba(255, 79, 0, 0.8); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; border: 2px solid rgba(255, 255, 255, 0.5); backdrop-filter: blur(5px); animation: pulse-play 2s infinite; }
    @keyframes pulse-play { 0% { box-shadow: 0 0 0 0 rgba(255, 79, 0, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 79, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 79, 0, 0); } }
    .section-title-wrapper { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .section-title { display: flex; align-items: center; gap: 0.75rem; }
    .section-title .accent-bar { width: 5px; height: 24px; background-color: var(--primary-color); border-radius: 99px; }
    .section-title h2 { font-weight: 700; font-size: 1.25rem; }
    .content-card { background-color: var(--card-bg); border-radius: 12px; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; }
    .content-card:hover { border-color: var(--accent-green); transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.5); }
    .card-img-container { position: relative; }
    .play-icon-overlay { position: absolute; inset: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
    .content-card:hover .play-icon-overlay { opacity: 1; }
    .play-icon-overlay .main-play-icon { font-size: 40px; color: white; }
    .live-tv-channel { display: block; position: relative; transition: transform 0.3s ease; }
    .live-tv-channel:hover { transform: scale(1.05); } .live-tv-channel img { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 50%; border: 2px solid var(--accent-green); }
    .badge { position: absolute; top: 10px; font-size: 10px; font-weight: 600; padding: 4px 8px; border-radius: 7px; backdrop-filter: blur(5px); color: white; z-index: 3; }
    .badge-live { left: 10px; background-color: rgba(239, 68, 68, 0.85); display: flex; align-items: center; gap: 5px; }
.badge-upcoming {
    left: 10px;
    background-color: rgba(34, 197, 94, 0.85);
    display: flex;
    align-items: center;
    gap: 5px;
    animation: upcoming-glow 2.5s infinite ease-in-out;
}

.badge-highlights {
    left: 10px;
    background-color: rgba(59, 130, 246, 0.85); /* A nice blue color */
    display: flex;
    align-items: center;
    gap: 5px;
}

    .badge-new { right: 10px; background: red; animation: new-pop 0.5s ease-out; }
    @keyframes new-pop { from { transform: scale(0.5) translateX(10px); opacity: 0; } to { transform: scale(1) translateX(0); opacity: 1; } }
    .live-dot { width: 7px; height: 7px; background-color: #fff; border-radius: 50%; animation: live-pulse 1.5s infinite; }
    @keyframes live-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 70px; background: rgba(10, 10, 10, 0.8); backdrop-filter: blur(10px); border-top: 1px solid rgba(255, 255, 255, 0.1); display: flex; justify-content: space-around; align-items: center; z-index: 50; padding-bottom: env(safe-area-inset-bottom); }
    .nav-button { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: #888; font-size: 11px; font-weight: 500; transition: color 0.3s, transform 0.3s; flex: 1; height: 100%; }
    .nav-button.active { color: var(--primary-color); } .nav-button i, .nav-button img { font-size: 20px; height: 22px; transition: transform 0.3s; } .nav-button.active i, .nav-button.active img { transform: scale(1.1); }
    .nav-button img { filter: grayscale(100%) brightness(1.2); } .nav-button.active img { filter: none; }
    .page-content { display: none; animation: contentFadeIn 0.5s ease-out; }
    .page-content.active { display: block; }
    @keyframes contentFadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    #search-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(10, 10, 10, 0.9); backdrop-filter: blur(16px); z-index: 200; display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
    body.search-overlay-active #search-overlay { display: flex; opacity: 1; }
    .search-result-item { display: flex; align-items: center; padding: 10px; margin-bottom: 10px; background-color: rgba(255,255,255,0.05); border-radius: 8px; transition: background-color 0.3s; } .search-result-item:hover { background-color: rgba(255,255,255,0.1); }
    .search-result-item img { width: 50px; height: 75px; object-fit: cover; border-radius: 4px; margin-right: 15px; }
    #grid-page-view { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-dark); z-index: 100; overflow-y: auto; }
    .shimmer { background: linear-gradient(90deg, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite linear; }
    @keyframes shimmer { from { background-position: 200% 0; } to { background-position: -200% 0; } }
    .skeleton-card { border-radius: 12px; overflow: hidden; background-color: var(--card-bg); }
    .skeleton-card .img { height: 0; padding-bottom: 150%; background-color: #2a2a2a; } .skeleton-card .img.thumbnail { padding-bottom: 56.25%; }
    .skeleton-card .title { height: 20px; margin-top: 8px; background-color: #2a2a2a; border-radius: 4px; width: 80%; }
    .scrollbar-hide::-webkit-scrollbar { display: none; } .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

    /* --- Player Page Styles (Final) --- */
    #player-page-view { display: none; background-color: #000; color: #fff; font-family: 'Baloo 2', cursive; }
    #player-wrapper { position: relative; width: 100%; background-color: #000; transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
    #player-wrapper .player-content { position: relative; width: 100%; padding-top: 56.25%; display: flex; align-items: center; justify-content: center; }
    #player-wrapper .player-content iframe, #player-wrapper .player-content video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; object-fit: contain; }

    .player-loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 25; display: none; }
    .player-loader i { font-size: 48px; color: rgba(255,255,255,0.8); }
    #player-wrapper.loading .player-loader { display: block; }
    #player-wrapper.loading .player-content > i { display: none; }

    #player-wrapper.rotated-view { position: fixed; top: 0; left: 0; width: 100vh; height: 100vw; transform-origin: center; transform: rotate(90deg) translate(calc((100vh - 100vw) / 2), calc((100vh - 100vw) / 2)); z-index: 9999; background: #000; }
    #player-wrapper.rotated-view .player-content { width: 100%; height: 100%; padding-top: 0; }
    .view-mode-btn { position: absolute; color: white; background: none; border: none; width: 50px; height: 50px; cursor: pointer; font-size: 22px; display: flex; align-items: center; justify-content: center; z-index: 22; text-shadow: 0 0 8px rgba(0,0,0,0.8); transition: opacity 0.3s; }
    .enter-rotated-view-btn { bottom: 5px; right: 5px; } 
    .controls-bottom-bar .enter-rotated-view-btn { position: static; } 
    #player-wrapper.rotated-view .enter-rotated-view-btn { display: none; }
    
    /* Updated Rotated View Close Button */
    .close-rotated-view-btn {
        bottom: 15px;
        right: 15px;
        display: none;
        transform: rotate(-90deg);
        color: var(--primary-color);
        background-color: rgba(26, 26, 26, 0.7);
        border-radius: 50%;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        width: 45px;
        height: 45px;
    }
    #player-wrapper.rotated-view .close-rotated-view-btn { display: flex; }

    #custom-controls-overlay { position: absolute; inset: 0; z-index: 20; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; background: radial-gradient(circle, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0) 70%); pointer-events: none; }
    #custom-controls-overlay.visible { opacity: 1; }
    #custom-play-pause-btn { pointer-events: auto; width: 75px; height: 75px; background: radial-gradient(circle, rgba(255, 79, 0, 0.7) 0%, rgba(255, 79, 0, 0.4) 100%); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 50%; color: white; font-size: 34px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); cursor: pointer; transition: all 0.2s ease; box-shadow: 0 0 25px rgba(255, 79, 0, 0.4); }
    #custom-play-pause-btn:hover { transform: scale(1.1); box-shadow: 0 0 35px rgba(255, 79, 0, 0.6); } 
    #custom-play-pause-btn .fa-play { margin-left: 6px; }

    #player-controls-container { position: absolute; bottom: 0; left: 0; right: 0; z-index: 21; padding: 10px 15px; background: linear-gradient(to top, rgba(0,0,0,0.85), transparent); opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; display: flex; flex-direction: column; gap: 8px; }
    #player-wrapper.controls-visible #player-controls-container { opacity: 1; visibility: visible; }
    #progress-bar { -webkit-appearance: none; appearance: none; width: 100%; height: 5px; background: rgba(255, 255, 255, 0.3); border-radius: 5px; outline: none; cursor: pointer; transition: height 0.2s; }
    #progress-bar:hover { height: 8px; }
    #progress-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 15px; height: 15px; background: var(--primary-color); border-radius: 50%; cursor: pointer; }
    #progress-bar::-moz-range-thumb { width: 15px; height: 15px; background: var(--primary-color); border-radius: 50%; cursor: pointer; border: none; }
    .controls-bottom-bar { display: flex; justify-content: space-between; align-items: center; color: white; font-size: 14px; font-weight: 500; width: 100%; }
    .controls-bottom-bar button { background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 5px; }
    .controls-left, .controls-right { display: flex; align-items: center; gap: 1rem; }
    #time-display { font-family: 'Poppins', sans-serif; letter-spacing: 0.5px; }

    #double-tap-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; z-index: 19; }
    .tap-zone { flex: 1; height: calc(100% - 80px); }
    
    /* New & Improved Gesture Control Indicators */
    .vertical-indicator {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        width: 36px;
        padding: 15px 0;
        background-color: rgba(0, 0, 0, 0.6);
        border-radius: 18px;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, visibility 0.2s;
        z-index: 25;
        pointer-events: none; /* Add this */
    }
    .vertical-indicator.visible {
        opacity: 1;
        visibility: visible;
    }
    .vertical-indicator i {
        font-size: 18px;
        color: white;
    }
    .vertical-indicator .indicator-bar-container {
        width: 5px;
        height: 100px;
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 5px;
        position: relative;
        overflow: hidden;
    }
    .vertical-indicator .indicator-bar-level {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: white;
        border-radius: 5px;
        transition: height 0.1s linear;
    }

    #volume-indicator-v {
        right: 30px;
    }
    #brightness-indicator-v {
        left: 30px;
    }

    #player-wrapper.rotated-view #volume-indicator-v {
        right: 50px;
    }
    #player-wrapper.rotated-view #brightness-indicator-v {
        left: 50px;
    }

    /* --- Other Player Page Styles --- */
    #player-page-view main { padding-bottom: 20px; }
    .player-related-card.is-poster .image-container { width: 100%; height: 160px; } .player-related-card.is-logo .image-container { width: 100px; height: 100px; border-radius: 12px; }
    .player-related-card img:hover { transform: scale(1.05); }
    #comment-section { position: fixed; bottom: 0; left: 0; right: 0; height: 70%; background-color: #121212; border-top: 1px solid #282828; transform: translateY(100%); transition: transform 0.4s ease-in-out; z-index: 150; padding-bottom: env(safe-area-inset-bottom); }
    #comment-section.open { transform: translateY(0); }
</style>

</head>
<body>
    <div id="drawer-overlay" class="fixed inset-0 bg-black/60 z-[90] hidden"></div>
    <nav id="nav-drawer" class="fixed top-0 left-0 h-full w-72 max-w-[80vw] bg-[#121212] z-[91] flex flex-col p-5 transform -translate-x-full transition-transform duration-300 ease-in-out">
        <div class="flex flex-col items-center mb-8">
            <img src="https://www.easykoro.com/inventories/fit-in/600x800/803377601954796.png" alt="App Logo" class="w-20 h-20 rounded-full border-2 border-[var(--primary-color)] object-cover mb-3">
            <h2 class="text-2xl font-bold text-white" style="font-family: 'Baloo 2', cursive;">Great Family Tv</h2>
        </div>

<div class="flex-grow space-y-3">
        <div class="text-gray-400 text-sm font-semibold mb-2 px-3">SETTINGS</div>
        <div class="flex items-center justify-between bg-gray-800/50 rounded-lg px-3 py-2.5">
            <label for="autoplay-toggle" class="font-medium text-gray-200">On Autoplay</label>
            <!-- স্টাইলিশ টগল সুইচ -->
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="autoplay-toggle" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[var(--primary-color)]"></div>
            </label>
        </div>
        
        <div class="pt-6">
             <a href="https://great-family-tv.github.io/download/" class="drawer-link"><i class="fas fa-globe-americas w-6"></i> Visit Website</a>
             <a href="https://t.me/GreatFamilyTv" class="drawer-link"><i class="fab fa-telegram-plane w-6"></i> Join Telegram</a>
             <a href="#" class="drawer-link"><i class="fas fa-shield-alt w-6"></i> Privacy Policy</a>
        </div>
    </div>

    <div class="text-center text-gray-500 text-xs">
        version 1.1  |  by rafid
    </div>
</nav>

<div id="app-shell">
    <header class="main-header flex items-center justify-between px-4 h-[60px] sticky top-0 z-40">
<div class="flex items-center gap-4">
    <!-- নতুন মেনু বাটন -->
    <button id="drawer-open-btn" aria-label="Open Menu" class="text-2xl text-gray-300 hover:text-[var(--primary-color)] transition-colors">
        <!-- এখানে আপনি আপনার দেওয়া ইমেজও ব্যবহার করতে পারেন -->
        <i class="fas fa-bars"></i>
    </button>
    <div id="header-title-container" class="flex items-center gap-3">
        <i id="page-title-icon" class="text-2xl transition-all duration-300 ease-in-out"></i>
        <h1 id="page-title-header" class="text-xl font-bold text-white transition-opacity duration-300 ease-in-out"></h1>
    </div>
</div>
<button id="search-open-btn" aria-label="Search" class="text-2xl text-gray-300 hover:text-[var(--primary-color)] transition-colors"><i class="fas fa-search"></i></button>
</header>
        <main class="p-4 md:p-6">
            <div id="home-page" class="page-content active"><section id="banner-container" class="relative w-full group mb-8 rounded-lg overflow-hidden"><div class="shimmer w-full h-full"></div></section><div id="home-sections-container" class="space-y-8"></div></div>
            <div id="livetv-page" class="page-content"></div><div id="cricket-page" class="page-content space-y-8"></div><div id="movies-page" class="page-content space-y-8"></div>
        </main>
        <footer class="bg-[#0B0B0B] text-gray-400 pt-10 pb-7 text-sm mt-auto"></footer>
        <nav class="bottom-nav">
            <button data-target="home-page" class="nav-button"><img src="https://www.easykoro.com/inventories/fit-in/600x800/772401184834694.png" alt="Cricket" class="h-10 w-6"/><span>HOME</span></button>
            <button data-target="livetv-page" class="nav-button"><img src="https://www.easykoro.com/inventories/fit-in/600x800/772377272974914.png" alt="Cricket" class="h-10 w-6"/><span>LIVE TV</span></button>
            <button data-target="cricket-page" class="nav-button"><img src="https://www.easykoro.com/inventories/fit-in/600x800/786352897906669.png" alt="Cricket" class="h-10 w-6"/><span>SPORTS</span></button>
            <button data-target="movies-page" class="nav-button"><img src="https://www.easykoro.com/inventories/fit-in/600x800/772144044690327.png" alt="Cricket" class="h-10 w-6"/><span>MOVIES</span></button>
        </nav>
    </div>

<div id="grid-page-view">
    <header class="flex items-center p-4 bg-black/90 backdrop-blur-sm sticky top-0 z-10 border-b border-gray-800"><button id="grid-back-btn" class="text-xl mr-4 hover:text-[var(--primary-color)]"><i class="fas fa-arrow-left"></i></button><h2 id="grid-page-title" class="text-lg font-bold truncate"></h2></header>
    <main id="grid-page-content" class="p-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></main>
</div>
<div id="search-overlay" class="flex-col p-4">
    <header class="flex items-center w-full mb-6"><input id="search-input" type="text" placeholder="Search for Movies, Sports..." class="w-full bg-transparent text-xl font-semibold text-white focus:outline-none border-b-2 border-gray-600 focus:border-[var(--primary-color)] transition-colors pb-2"><button id="search-close-btn" aria-label="Close Search" class="text-3xl ml-4 text-gray-400 hover:text-white"><i class="fas fa-times"></i></button></header>
    <main id="search-results-container" class="w-full flex-1 overflow-y-auto pr-2 scrollbar-hide"><div id="search-placeholder" class="text-center text-gray-500 mt-10">Type something to start searching.</div></main>
</div>

<div id="player-page-view">
     <header class="p-4 bg-black/90 backdrop-blur-sm sticky top-0 z-20 flex items-center"><button id="player-back-btn" class="text-xl mr-4 hover:text-[var(--primary-color)]"><i class="fas fa-arrow-left"></i></button><h2 id="player-page-title-header" class="text-lg font-bold truncate"></h2></header>
    <section id="player-container" class="w-full bg-black">
        <div id="player-wrapper"><div class="player-content"><i class="fas fa-spinner fa-spin text-4xl text-gray-500"></i></div></div>
    </section>
    <main class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <section id="action-bar" class="py-4 flex flex-wrap gap-4 items-center justify-between text-gray-400 border-b border-gray-800"><div class="flex items-center space-x-6"><button id="like-btn" class="action-btn flex items-center space-x-2"><i class="far fa-thumbs-up text-xl"></i><span id="like-count">0</span></button><button id="dislike-btn" class="action-btn flex items-center space-x-2"><i class="far fa-thumbs-down text-xl"></i><span id="dislike-count">0</span></button><button id="comment-btn" class="action-btn flex items-center space-x-2"><i class="far fa-comment-alt text-xl"></i><span>Comment</span></button></div><button id="report-btn" class="action-btn flex items-center space-x-2"><i class="far fa-flag text-xl"></i><span>Report</span></button></section>
        <section id="movie-info" class="py-6"></section>
        <section id="related-content" class="py-6"><h3 id="related-title" class="text-white text-lg font-semibold mb-3"></h3><div id="related-content-container" class="flex items-start space-x-4 overflow-x-auto scrollbar-hide pb-2"></div></section>
    </main>
    <section id="comment-section" class="flex flex-col"><header class="p-4 border-b border-gray-700 flex justify-between items-center"><h3 class="text-lg font-semibold">Comments</h3><button id="close-comments-btn" class="text-2xl hover:text-white text-gray-400">×</button></header><div id="comments-list" class="flex-grow p-4 overflow-y-auto"></div><form id="comment-form" class="p-4 border-t border-gray-700 flex items-center"><input id="comment-input" type="text" class="w-full bg-gray-800 text-white rounded-l-md p-2 focus:outline-none focus:ring-2 focus:ring-green-600" placeholder="Add a comment..."><button type="submit" class="bg-green-600 text-white p-2 rounded-r-md hover:bg-green-700">Send</button></form></section>
</div>

<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<!-- আপনার পুরোনো <script> ব্লকটি ডিলিট করে নিচের সম্পূর্ণ নতুন ব্লকটি পেস্ট করুন -->
<!-- আপনার পুরোনো <script> ব্লকটি ডিলিট করে নিচের সম্পূর্ণ নতুন ব্লকটি পেস্ট করুন -->

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy, doc, onSnapshot, addDoc, serverTimestamp, updateDoc, increment, where, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAb8YsPMOY53GxiycCL6G0MPZdgWe3nnyY", authDomain: "movie-92659.firebaseapp.com", projectId: "movie-92659", storageBucket: "movie-92659.appspot.com", messagingSenderId: "1090734362509", appId: "1:1090734362509:web:86be5583f6e8fcfdfa77c4" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const UI = { appShell: document.getElementById('app-shell'), playerPageView: document.getElementById('player-page-view'), pages: document.querySelectorAll('.page-content'), bannerContainer: document.getElementById('banner-container'), gridPageView: document.getElementById('grid-page-view'), gridPageTitle: document.getElementById('grid-page-title'), gridPageContent: document.getElementById('grid-page-content'), searchOverlay: document.getElementById('search-overlay'), searchInput: document.getElementById('search-input'), searchResultsContainer: document.getElementById('search-results-container'), searchPlaceholder: document.getElementById('search-placeholder'), pageTitleHeader: document.getElementById('page-title-header'), pageTitleIcon: document.getElementById('page-title-icon') };

    const Render = {
        card: (item, cardType = 'poster', isGridItem = false) => {
            const aspectClass = cardType === 'thumbnail' ? 'aspect-video' : 'aspect-[2/3]';
            let badges = '';

            // --- নতুন এবং আপডেটেড ব্যাজ লজিক ---
            if (cardType === 'thumbnail') {
                if (item.isLive === true) {
                    badges += `<span class="badge badge-live"><span class="live-dot"></span>Live</span>`;
                } else {
                    // লাইভ না হলে, টাইটেল চেক করুন এটি হাইলাইটস কিনা
                    const highlightKeywords = ['highlights', 'extended', 'full match', 'recap', 'replay', 'classic match'];
                    const title = (item.title || '').toLowerCase();
                    const isHighlight = highlightKeywords.some(keyword => title.includes(keyword));

                    if (isHighlight) {
                        // যদি টাইটেলে হাইলাইটস সম্পর্কিত শব্দ থাকে
                        badges += `<span class="badge badge-highlights"><i class="fas fa-history"></i> Highlights</span>`;
                    } else {
                        // অন্যথায়, আপকামিং দেখান
                        badges += `<span class="badge badge-upcoming"><i class="far fa-clock"></i> Upcoming</span>`;
                    }
                }
            }

            // মুভি/পোস্টারের জন্য NEW ব্যাজ
            if (cardType !== 'thumbnail' && item.createdAt && (Date.now() - item.createdAt.toDate().getTime()) < 24 * 60 * 60 * 1000) {
                badges += `<span class="badge badge-new">NEW</span>`;
            }

            const sizeClass = isGridItem ? 'w-full' : (cardType === 'thumbnail' ? 'w-60 flex-shrink-0' : 'w-36 sm:w-40 flex-shrink-0');
            const fallbackImage = 'https://via.placeholder.com/300x450.png?text=Image+Not+Found';
            return `<div class="${sizeClass}"><a href="#" data-id="${item.link}" class="block group content-link"><div class="content-card"><div class="card-img-container relative ${aspectClass}">${badges}<img alt="${item.title||item.name}" class="w-full h-full object-cover" src="${item.posterUrl}" loading="lazy" onerror="this.onerror=null;this.src='${fallbackImage}';"/><div class="play-icon-overlay"><i class="fas fa-play main-play-icon"></i></div></div></div><p class="text-sm font-semibold mt-2 truncate group-hover:text-[var(--primary-color)] transition-colors">${item.title||item.name}</p></a></div>`;
        },
        liveTvChannelCard: (item) => `<div class="flex-shrink-0 w-24 text-center"><a href="#" data-id="liveTV/${item.id}" class="live-tv-channel content-link"><img src="${item.logoUrl}" alt="${item.name}" onerror="this.onerror=null;this.src='https://via.placeholder.com/100x100.png?text=Logo';" /></a><p class="text-xs mt-1 truncate font-medium text-gray-300">${item.name}</p></div>`,
        section: (s, i, t, d) => `<section class="space-y-4"><div class="section-title-wrapper"><div class="section-title"><span class="accent-bar"></span><h2>${s.title}</h2></div><button class="see-more-btn text-xs font-semibold text-gray-400 hover:text-[var(--primary-color)]" data-title="${s.title}" data-type="${t}" data-section-id="${d}">View All <i class="fas fa-angle-right ml-1"></i></button></div><div class="flex overflow-x-auto gap-4 pb-2 scrollbar-hide -mx-4 px-4">${i}</div></section>`,
        liveTvSection: (i) => `<section class="space-y-4"><div class="section-title-wrapper"><div class="section-title"><span class="accent-bar"></span><h2>Live TV Channels</h2></div></div><div class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8 gap-4">${i}</div></section>`,
        searchResultItem: (i) => `<a href="#" data-id="${i.link}" class="search-result-item content-link"><img src="${i.posterUrl}" alt="${i.title}" onerror="this.onerror=null;this.src='https://via.placeholder.com/50x75.png?text=N/A';"/><p class="font-semibold">${i.title}</p></a>`,
        skeletonSection: (isThumbnail = false) => { const cardType = isThumbnail ? 'thumbnail' : ''; let cards = ''; for (let i = 0; i < 6; i++) { cards += `<div class="w-36 sm:w-40 flex-shrink-0"><div class="skeleton-card shimmer"><div class="img ${cardType}"></div><div class="title"></div></div></div>`; } return `<section class="space-y-4"><div class="section-title-wrapper"><div class="h-6 w-48 bg-[#2a2a2a] rounded shimmer"></div></div><div class="flex overflow-x-auto gap-4 pb-2 scrollbar-hide -mx-4 px-4">${cards}</div></section>`; }
    };

    const Player = {
        UI: {
            playerPageView: document.getElementById('player-page-view'),
            playerWrapper: document.getElementById('player-wrapper'),
            movieInfo: document.getElementById('movie-info'),
            relatedContainer: document.getElementById('related-content-container'),
            relatedTitle: document.getElementById('related-title'),
            likeBtn: document.getElementById('like-btn'),
            dislikeBtn: document.getElementById('dislike-btn'),
            likeCount: document.getElementById('like-count'),
            dislikeCount: document.getElementById('dislike-count'),
            commentBtn: document.getElementById('comment-btn'),
            commentSection: document.getElementById('comment-section'),
            closeCommentsBtn: document.getElementById('close-comments-btn'),
            commentForm: document.getElementById('comment-form'),
            commentInput: document.getElementById('comment-input'),
            commentsList: document.getElementById('comments-list'),
            playerTitleHeader: document.getElementById('player-page-title-header')
        },
        state: {
            movieRef: null,
            unsubscribe: null,
            currentVideoElement: null,
            controlsTimeout: null,
            hlsInstance: null,
            isScrubbing: false
        },

        init(id) {
            if (!id) return;
            if (this.state.unsubscribe) this.state.unsubscribe();
            this.cleanupPlayer();
            
            const playerContent = document.createElement('div');
            playerContent.className = 'player-content';
            this.UI.playerWrapper.appendChild(playerContent);
            
            const loader = document.createElement('div');
            loader.className = 'player-loader';
            loader.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            this.UI.playerWrapper.appendChild(loader);
            
            this.UI.playerWrapper.classList.add('loading');

            this.UI.movieInfo.innerHTML = '';
            this.UI.relatedContainer.innerHTML = '';
            
            this.state.movieRef = doc(db, id);
            let isFirstLoad = true;
            this.state.unsubscribe = onSnapshot(this.state.movieRef, (docSnap) => {
                if (!docSnap.exists()) {
                    this.UI.playerWrapper.classList.remove('loading');
                    if(playerContent) playerContent.innerHTML = `<p class="text-center p-4">Content not available.</p>`;
                    return;
                }
                const content = docSnap.data();
                if (isFirstLoad) {
                    this.createPlayer(content.videoUrl || content.streamUrl, content.posterUrl || content.logoUrl);
                    this.UI.playerTitleHeader.textContent = content.title || content.name;
                    this.UI.movieInfo.innerHTML = `<h1 class="text-2xl md:text-3xl font-bold mb-2">${content.title||content.name}</h1><p class="text-gray-300">${content.description||''}</p>`;
                    this.loadRelatedContent(id);
                    this.setupActionHandlers(id);
                    this.setupCommentSection(id);
                    isFirstLoad = false;
                }
                this.UI.likeCount.textContent = content.likes || 0;
                this.UI.dislikeCount.textContent = content.dislikes || 0;
                this.updateActionButtonsUI(id);
            });
        },

        createPlayer(videoUrl, posterUrl) {
            const playerContent = this.UI.playerWrapper.querySelector('.player-content');
            if (!playerContent) return;

            const lowerCaseUrl = videoUrl ? videoUrl.toLowerCase() : '';

            // ============== পরিবর্তন এখানে করা হয়েছে ==============
            const isBongoLink = lowerCaseUrl.includes('bongobd.com');
            const isDirectVideo = !isBongoLink && (lowerCaseUrl.endsWith('.m3u8') || ['.mp4', '.mkv', '.webm'].some(ext => lowerCaseUrl.includes(ext)) || lowerCaseUrl.includes('pixeldrain'));
            // =======================================================
            
            if (isDirectVideo && videoUrl) {
                playerContent.innerHTML = `<video id="video-player" poster="${posterUrl}" playsinline class="bg-black"></video>`;
                const video = document.getElementById('video-player');
                this.state.currentVideoElement = video;
                
                if (lowerCaseUrl.endsWith('.m3u8')) {
                    if (Hls.isSupported()) { 
                        this.state.hlsInstance = new Hls(); 
                        this.state.hlsInstance.loadSource(videoUrl); 
                        this.state.hlsInstance.attachMedia(video); 
                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) { 
                        video.src = videoUrl; 
                    }
                } else {
                    video.src = videoUrl;
                }
                this.setupAdvancedCustomControls(video);
            } else if (videoUrl) { // This block now handles Bongo links and other iframe-based content
                this.UI.playerWrapper.classList.remove('loading');
                playerContent.innerHTML = `<iframe src="${videoUrl}" frameborder="0" allow="autoplay; fullscreen; encrypted-media" allowfullscreen></iframe>`;
                this.addRotatedViewButtons(); 
                this.state.currentVideoElement = null;
            } else {
                this.UI.playerWrapper.classList.remove('loading');
                playerContent.innerHTML = `<p class="text-center p-4">No video source found.</p>`;
            }
        },
        
        addRotatedViewButtons() {
            const closeBtn = document.createElement('button');
            closeBtn.className = 'view-mode-btn close-rotated-view-btn';
            closeBtn.innerHTML = '<i class="fas fa-compress"></i>';
            closeBtn.onclick = (e) => { e.stopPropagation(); this.toggleRotateView(); };
            
            const enterBtn = document.createElement('button');
            enterBtn.className = 'view-mode-btn enter-rotated-view-btn';
            enterBtn.innerHTML = '<i class="fas fa-expand"></i>';
            enterBtn.onclick = (e) => { e.stopPropagation(); this.toggleRotateView(); };

            this.UI.playerWrapper.appendChild(closeBtn);
            this.UI.playerWrapper.appendChild(enterBtn);
        },

        setupAdvancedCustomControls(video) {
            const gestureIndicatorsHTML = `
                <div id="volume-indicator-v" class="vertical-indicator">
                    <i class="fas fa-volume-up"></i>
                    <div class="indicator-bar-container"><div class="indicator-bar-level"></div></div>
                </div>
                <div id="brightness-indicator-v" class="vertical-indicator">
                    <i class="fas fa-sun"></i>
                    <div class="indicator-bar-container"><div class="indicator-bar-level"></div></div>
                </div>
            `;
            this.UI.playerWrapper.insertAdjacentHTML('afterbegin', gestureIndicatorsHTML);

            const closeBtn = document.createElement('button');
            closeBtn.className = 'view-mode-btn close-rotated-view-btn';
            closeBtn.innerHTML = '<i class="fas fa-compress"></i>';
            closeBtn.onclick = (e) => { e.stopPropagation(); this.toggleRotateView(); };
            
            const controlsHTML = `
                <div id="double-tap-overlay"><div class="tap-zone" id="tap-rewind"></div><div class="tap-zone" id="tap-forward"></div></div>
                <div id="custom-controls-overlay" class="visible"><button id="custom-play-pause-btn"><i class="fas fa-play"></i></button></div>
                <div id="player-controls-container">
                    <input type="range" id="progress-bar" value="0" min="0" step="1">
                    <div class="controls-bottom-bar">
                        <div class="controls-left">
                            <button id="play-pause-btn"><i class="fas fa-play"></i></button>
                            <span id="time-display">00:00 / 00:00</span>
                        </div>
                        <div class="controls-right">
                             <button class="enter-rotated-view-btn"><i class="fas fa-expand"></i></button>
                        </div>
                    </div>
                </div>`;
            this.UI.playerWrapper.appendChild(closeBtn);
            this.UI.playerWrapper.insertAdjacentHTML('beforeend', controlsHTML);
            
            const customControlsOverlay = document.getElementById('custom-controls-overlay');
            const centerPlayPauseBtn = document.getElementById('custom-play-pause-btn');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const progressBar = document.getElementById('progress-bar');
            const timeDisplay = document.getElementById('time-display');
            const rotateBtn = this.UI.playerWrapper.querySelector('.enter-rotated-view-btn');
            const tapRewind = document.getElementById('tap-rewind');
            const tapForward = document.getElementById('tap-forward');

            const showControls = () => {
                this.UI.playerWrapper.classList.add('controls-visible');
                if (video.paused) customControlsOverlay.classList.add('visible');
                clearTimeout(this.state.controlsTimeout);
            };
            const hideControls = () => {
                if (video.paused || this.state.isScrubbing) return;
                this.state.controlsTimeout = setTimeout(() => {
                    this.UI.playerWrapper.classList.remove('controls-visible');
                    customControlsOverlay.classList.remove('visible');
                }, 3000);
            };
            this.UI.playerWrapper.addEventListener('mousemove', () => { showControls(); hideControls(); });
            this.UI.playerWrapper.addEventListener('click', (e) => {
                if (e.target.closest('.tap-zone') || e.target.closest('button') || e.target.closest('.vertical-indicator')) return;
                if(this.UI.playerWrapper.classList.contains('controls-visible')) {
                    this.UI.playerWrapper.classList.remove('controls-visible');
                    customControlsOverlay.classList.remove('visible');
                } else {
                    showControls(); hideControls();
                }
            });

            const formatTime = (time) => {
                if (isNaN(time)) return '00:00';
                const seconds = Math.floor(time % 60);
                const minutes = Math.floor(time / 60) % 60;
                const hours = Math.floor(time / 3600);
                return hours > 0
                    ? `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`
                    : `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            };
            const togglePlay = () => video.paused ? video.play() : video.pause();

            video.addEventListener('play', () => {
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                centerPlayPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                customControlsOverlay.classList.remove('visible');
                hideControls();
            });
            video.addEventListener('pause', () => {
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                centerPlayPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                showControls();
            });
            video.addEventListener('waiting', () => this.UI.playerWrapper.classList.add('loading'));
            video.addEventListener('playing', () => this.UI.playerWrapper.classList.remove('loading'));
            video.addEventListener('canplay', () => { this.UI.playerWrapper.classList.remove('loading'); video.play().catch(() => showControls()); });
            video.addEventListener('loadedmetadata', () => {
                progressBar.max = video.duration;
                timeDisplay.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
            });
            video.addEventListener('timeupdate', () => {
                if (!this.state.isScrubbing) progressBar.value = video.currentTime;
                timeDisplay.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
            });

            playPauseBtn.addEventListener('click', (e) => { e.stopPropagation(); togglePlay(); });
            centerPlayPauseBtn.addEventListener('click', (e) => { e.stopPropagation(); togglePlay(); });
            rotateBtn.onclick = (e) => { e.stopPropagation(); this.toggleRotateView(); };
            
            progressBar.addEventListener('mousedown', () => { this.state.isScrubbing = true; clearTimeout(this.state.controlsTimeout); });
            progressBar.addEventListener('mouseup', () => { this.state.isScrubbing = false; hideControls(); });
            progressBar.addEventListener('input', () => { timeDisplay.textContent = `${formatTime(progressBar.value)} / ${formatTime(video.duration)}`; });
            progressBar.addEventListener('change', () => { video.currentTime = progressBar.value; });
            
            const handleDoubleTap = (e) => {
                const currentTime = new Date().getTime();
                if (currentTime - (this.state.lastTap || 0) < 300) {
                    if (e.currentTarget.id === 'tap-rewind') video.currentTime -= 10;
                    if (e.currentTarget.id === 'tap-forward') video.currentTime += 10;
                    this.state.lastTap = 0;
                } else {
                    this.state.lastTap = currentTime;
                }
            };
            tapRewind.addEventListener('click', handleDoubleTap);
            tapForward.addEventListener('click', handleDoubleTap);
            
            video.addEventListener('ended', () => {
                const autoplayEnabled = localStorage.getItem('autoplayNext') === 'true';
                if (autoplayEnabled) {
                    const nextContentLink = Player.UI.relatedContainer.querySelector('.content-link');
                    if (nextContentLink && nextContentLink.dataset.id) {
                        App.showPlayerPage(nextContentLink.dataset.id);
                    }
                }
            });

            const playerWrapper = this.UI.playerWrapper;
            const volumeIndicator = document.getElementById('volume-indicator-v');
            const volumeLevel = volumeIndicator.querySelector('.indicator-bar-level');
            const brightnessIndicator = document.getElementById('brightness-indicator-v');
            const brightnessLevel = brightnessIndicator.querySelector('.indicator-bar-level');

            let startY = 0, startX = 0, isDragging = false, indicatorTimeout;
            let currentVolume = video.volume, currentBrightness = 1;

            const showIndicator = (indicator, level, value) => {
                level.style.height = `${value * 100}%`;
                indicator.classList.add('visible');

                clearTimeout(indicatorTimeout);
                indicatorTimeout = setTimeout(() => {
                    indicator.classList.remove('visible');
                }, 1500);
            };

            const handleTouchStart = (e) => {
                if (e.touches.length === 1) {
                    const touch = e.touches[0];
                    startY = touch.clientY;
                    startX = touch.clientX;
                    isDragging = true;
                }
            };
            
            const handleTouchMove = (e) => {
                if (!isDragging || e.touches.length !== 1 || e.target.closest('#player-controls-container')) return;
                e.preventDefault();

                const touch = e.touches[0];
                const rect = playerWrapper.getBoundingClientRect();
                const touchX = touch.clientX - rect.left;
                
                let deltaY = startY - touch.clientY;
                if(playerWrapper.classList.contains('rotated-view')) {
                   deltaY = -(startX - touch.clientX);
                   if (touch.clientY < rect.top + rect.height/2) { 
                      startX = 0; 
                   } else { 
                      startX = rect.width;
                   }
                } else {
                   startX = touchX;
                }

                if (startX < rect.width / 2) { 
                    const brightnessChange = deltaY / 200;
                    currentBrightness = Math.max(0.2, Math.min(1.5, currentBrightness + brightnessChange));
                    playerWrapper.style.filter = `brightness(${currentBrightness})`;
                    showIndicator(brightnessIndicator, brightnessLevel, (currentBrightness - 0.2) / 1.3);
                } else { 
                    const volumeChange = deltaY / 200;
                    currentVolume = Math.max(0, Math.min(1, currentVolume + volumeChange));
                    video.volume = currentVolume;
                    showIndicator(volumeIndicator, volumeLevel, currentVolume);
                }

                if(playerWrapper.classList.contains('rotated-view')) {
                   startX = touch.clientX;
                }
                startY = touch.clientY;
            };

            const handleTouchEnd = () => {
                isDragging = false;
                clearTimeout(indicatorTimeout);
                indicatorTimeout = setTimeout(() => {
                    volumeIndicator.classList.remove('visible');
                    brightnessIndicator.classList.remove('visible');
                }, 500);
            };
            
            playerWrapper.addEventListener('touchstart', handleTouchStart, { passive: true });
            playerWrapper.addEventListener('touchmove', handleTouchMove, { passive: false });
            playerWrapper.addEventListener('touchend', handleTouchEnd);

            video.addEventListener('volumechange', () => {
                currentVolume = video.volume;
                if (volumeLevel) volumeLevel.style.height = `${currentVolume * 100}%`;
            });
        },

        toggleRotateView() {
            const isRotated = this.UI.playerWrapper.classList.toggle('rotated-view');
            document.body.style.overflow = isRotated ? 'hidden' : '';
        },

        cleanupPlayer() {
            if (this.state.hlsInstance) {
                this.state.hlsInstance.destroy();
                this.state.hlsInstance = null;
            }
            if (this.state.currentVideoElement) {
                this.state.currentVideoElement.pause();
                this.state.currentVideoElement.removeAttribute('src');
                this.state.currentVideoElement.load();
            }
            this.UI.playerWrapper.innerHTML = '';
            this.UI.playerWrapper.classList.remove('loading', 'controls-visible', 'rotated-view');
            clearTimeout(this.state.controlsTimeout);
            document.body.style.overflow = '';
        },

        destroyPlayer() {
            this.cleanupPlayer();
            if (this.state.unsubscribe) {
                this.state.unsubscribe();
                this.state.unsubscribe = null;
            }
        },
        
        async loadRelatedContent(path) {
             this.UI.relatedContainer.innerHTML = '';
             const currentId = path.split('/').pop();
             const isLiveTv = path.startsWith('liveTV');
             this.UI.relatedTitle.textContent = isLiveTv ? 'Other Channels' : 'You may also like';
             const collectionPath = isLiveTv ? 'liveTV' : path.substring(0, path.lastIndexOf('/'));
             const q = query(collection(db, collectionPath), where("__name__", "!=", currentId), limit(10));
             const snapshot = await getDocs(q);
             snapshot.forEach(docSnap => {
                 const content = docSnap.data();
                 const card = document.createElement('div');
                 const typeClass = isLiveTv ? 'is-logo' : 'is-poster';
                 card.className = `flex-shrink-0 player-related-card ${typeClass}`;
                 card.innerHTML = `
                    <a href="#" data-id="${collectionPath}/${docSnap.id}" class="content-link block group">
                        <div class="image-container">
                            <img alt="${content.title || content.name}" src="${content.posterUrl || content.logoUrl}" loading="lazy" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" />
                        </div>
                        <p class="text-gray-300 text-sm mt-1.5 truncate ${isLiveTv ? 'w-24 text-center' : 'w-36'} group-hover:text-[var(--primary-color)] transition-colors">${content.title || content.name}</p>
                    </a>`;
                 this.UI.relatedContainer.appendChild(card);
             });
        },
        setupActionHandlers(p){const k=`action_${p.replace(/\//g,'_')}`;this.UI.likeBtn.onclick=()=>this.handleVote('likes',k);this.UI.dislikeBtn.onclick=()=>this.handleVote('dislikes',k)},async handleVote(t,k){const c=localStorage.getItem(k),o=t==='likes'?'dislikes':'likes';let u={};c===t?(u[t]=increment(-1),localStorage.removeItem(k)):(u[t]=increment(1),c&&(u[o]=increment(-1)),localStorage.setItem(k,t));await updateDoc(this.state.movieRef,u)},updateActionButtonsUI(p){const k=`action_${p.replace(/\//g,'_')}`,v=localStorage.getItem(k);this.UI.likeBtn.classList.toggle('active',v==='likes');this.UI.dislikeBtn.classList.toggle('active',v==='dislikes')},setupCommentSection(p){const c=collection(db,`${p}/comments`);this.UI.commentBtn.onclick=()=>this.UI.commentSection.classList.add('open');this.UI.closeCommentsBtn.onclick=()=>this.UI.commentSection.classList.remove('open');this.UI.commentForm.onsubmit=async e=>{e.preventDefault();const t=this.UI.commentInput.value.trim();if(t){await addDoc(c,{text:t,author:"User",createdAt:serverTimestamp()});this.UI.commentInput.value=''}};this.listenForComments(c)},listenForComments(r){onSnapshot(query(r,orderBy('createdAt','desc')),s=>{this.UI.commentsList.innerHTML='';s.forEach(d=>{const c=d.data(),a=c.createdAt?.toDate().toLocaleString()||'',e=document.createElement('div');e.className='border-b border-gray-700 py-3';e.innerHTML=`<div class="flex items-start space-x-3"><i class="fas fa-user-circle text-2xl text-gray-400"></i><div><p class="font-semibold">${c.author} <span class="text-xs text-gray-500 ml-2">${a}</span></p><p class="text-gray-300 break-words">${c.text}</p></div></div>`;this.UI.commentsList.appendChild(e)})})}
    };
    
    const Drawer = {
        drawer: null,
        overlay: null,
        openBtn: null,
        body: null,
        autoplayToggle: null,
        init() {
            this.drawer = document.getElementById('nav-drawer');
            this.overlay = document.getElementById('drawer-overlay');
            this.openBtn = document.getElementById('drawer-open-btn');
            this.autoplayToggle = document.getElementById('autoplay-toggle');
            this.body = document.body;

            if(!this.drawer || !this.overlay || !this.openBtn) return;

            this.openBtn.addEventListener('click', this.open.bind(this));
            this.overlay.addEventListener('click', this.close.bind(this));
            
            this.setupSwipeToClose();
            this.setupAutoplayToggle();
        },
        open() {
            this.body.classList.add('drawer-open');
        },
        close() {
            this.body.classList.remove('drawer-open');
        },
        setupAutoplayToggle() {
            const isAutoplayEnabled = localStorage.getItem('autoplayNext') === 'true';
            this.autoplayToggle.checked = isAutoplayEnabled;
            this.autoplayToggle.addEventListener('change', (e) => {
                localStorage.setItem('autoplayNext', e.target.checked);
            });
        },
        setupSwipeToClose() {
            let touchStartX = 0;
            let touchCurrentX = 0;
            const drawerWidth = this.drawer.offsetWidth;

            this.drawer.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchCurrentX = touchStartX;
            }, { passive: true });

            this.drawer.addEventListener('touchmove', (e) => {
                touchCurrentX = e.touches[0].clientX;
                const deltaX = touchCurrentX - touchStartX;
                if (deltaX < 0) { 
                    this.drawer.style.transition = 'none';
                    this.drawer.style.transform = `translateX(${deltaX}px)`;
                }
            }, { passive: true });

            this.drawer.addEventListener('touchend', () => {
                this.drawer.style.transition = 'transform 0.3s ease-in-out';
                const deltaX = touchCurrentX - touchStartX;
                if (deltaX < -(drawerWidth * 0.25)) {
                    this.close();
                }
                this.drawer.style.transform = '';
            });
        }
    };

    const App = {
        contentCache: {}, allContent: [],
        setupEventListeners() {
            document.querySelectorAll('.nav-button').forEach(b => b.addEventListener('click', () => App.switchPage(b.dataset.target)));
            document.getElementById('search-open-btn').addEventListener('click', () => { document.body.classList.add('search-overlay-active'); UI.searchInput.focus(); });
            document.getElementById('search-close-btn').addEventListener('click', () => document.body.classList.remove('search-overlay-active'));
            
            document.body.addEventListener('click', e => {
                const contentLink = e.target.closest('.content-link');
                if (contentLink) {
                    e.preventDefault();
                    if (document.body.classList.contains('search-overlay-active')) {
                        document.body.classList.remove('search-overlay-active');
                    }

                    const clickedId = contentLink.dataset.id;
                    
                    if (clickedId && !clickedId.includes('/')) {
                        const searchTerm = clickedId.toLowerCase().trim();
                        const foundItem = App.allContent.find(item => 
                            (item.title || item.name || '').toLowerCase().trim() === searchTerm
                        );

                        if (foundItem && foundItem.link) {
                            App.showPlayerPage(foundItem.link);
                        } else {
                            console.warn(`Banner content with title "${clickedId}" not found.`);
                            alert(`Content "${clickedId}" could not be found. It might have been removed.`);
                        }
                    } else if (clickedId) {
                        App.showPlayerPage(clickedId);
                    }
                    return;
                }

                const seeMoreBtn = e.target.closest('.see-more-btn');
                if (seeMoreBtn) {
                    if (seeMoreBtn.dataset.type === 'livetv-redirect') App.switchPage('livetv-page');
                    else App.showGridView(seeMoreBtn.dataset.title, seeMoreBtn.dataset.type, seeMoreBtn.dataset.sectionId);
                }
            });

            document.getElementById('grid-back-btn').addEventListener('click', () => { UI.gridPageView.style.display = 'none'; });
            document.getElementById('player-back-btn').addEventListener('click', App.hidePlayerPage);
            UI.searchInput.addEventListener('input', App.handleSearch);
        },
        showPlayerPage(id) {
            UI.appShell.style.display = 'none';
            UI.gridPageView.style.display = 'none';
            UI.playerPageView.style.display = 'block';
            window.scrollTo(0, 0);
            Player.init(id);
        },
        hidePlayerPage() {
            Player.destroyPlayer();
            UI.appShell.style.display = 'flex';
            UI.playerPageView.style.display = 'none';
        },
        handleSearch(e) {
            const q = e.target.value.toLowerCase().trim();
            UI.searchPlaceholder.style.display = q.length < 2 ? 'block' : 'none';
            if (q.length < 2) { UI.searchResultsContainer.innerHTML = ''; return; }
            const r = App.allContent.filter(i => (i.title || i.name || '').toLowerCase().includes(q));
            UI.searchResultsContainer.innerHTML = r.length > 0 ? r.map(Render.searchResultItem).join('') : `<p class="text-center text-gray-500 mt-10">No results found for "${q}"</p>`;
        },
        switchPage(id) {
            document.querySelectorAll('.nav-button').forEach(b => b.classList.toggle('active', b.dataset.target === id));
            UI.pages.forEach(p => p.classList.toggle('active', p.id === id));
            window.scrollTo(0, 0);
            const config = { 'home-page': { title: 'Home', icon: 'fas fa-home' }, 'livetv-page': { title: 'Live TV', icon: 'fas fa-tv' }, 'cricket-page': { title: 'Sports', icon: 'fas fa-basketball-ball' }, 'movies-page': { title: 'Movies', icon: 'fas fa-clapperboard' } }[id] || { title: 'Ti Sports', icon: 'fas fa-play-circle' };
            UI.pageTitleHeader.classList.add('opacity-0');
            UI.pageTitleIcon.classList.add('opacity-0', 'transform', 'scale-50');
            setTimeout(() => {
                UI.pageTitleHeader.textContent = config.title;
                UI.pageTitleIcon.className = `${config.icon} text-2xl transition-all duration-300 ease-in-out`;
                UI.pageTitleIcon.style.color = 'var(--primary-color)';
                UI.pageTitleHeader.classList.remove('opacity-0');
                UI.pageTitleIcon.classList.remove('opacity-0', 'transform', 'scale-50');
            }, 150);
        },
        async showGridView(title, type, sectionId) {
            UI.gridPageTitle.textContent = title;
            const cardType = type === 'cricket' ? 'thumbnail' : 'poster';
            UI.gridPageContent.innerHTML = Array(12).fill(`<div class="w-full skeleton-card shimmer"><div class="img ${cardType==='thumbnail'?'thumbnail':''}"></div><div class="title"></div></div>`).join('');
            UI.gridPageView.style.display = 'block';
            
            const q = query(collection(db, `${type}Sections/${sectionId}/items`), orderBy("order", "asc"));
            
            const snapshot = await getDocs(q);
            let html = '';
            snapshot.forEach(doc => {
                const itemData = { ...doc.data(), link: `${type}Sections/${sectionId}/items/${doc.id}` };
                html += Render.card(itemData, cardType, true);
            });
            UI.gridPageContent.innerHTML = html;
        },
        renderSkeletons() {
            UI.bannerContainer.innerHTML = `<div class="shimmer w-full h-full"></div>`;
            document.getElementById('home-sections-container').innerHTML = Render.skeletonSection() + Render.skeletonSection(true) + Render.skeletonSection();
        },
        async fetchAllContent() {
            if (App.allContent.length > 0) return;
            this.renderSkeletons();
            
            const bannerSnapshot = await getDocs(query(collection(db, "banners"), orderBy("order")));
            if (!bannerSnapshot.empty) {
                UI.bannerContainer.innerHTML = `<div class="swiper h-full"><div id="banner-wrapper" class="swiper-wrapper"></div><div class="swiper-pagination"></div></div>`;
                const bannerWrapper = document.getElementById('banner-wrapper');
                bannerSnapshot.forEach(doc => {
                    const item = doc.data();
                    bannerWrapper.innerHTML += `<div class="swiper-slide"><a href="#" data-id="${item.link||''}" class="content-link"><img src="${item.posterUrl}" alt="${item.title||''}" loading="eager"/><div class="banner-play-icon"><i class="fas fa-play"></i></div></a></div>`;
                });
                new Swiper('#banner-container .swiper', { loop: true, autoplay: { delay: 3500 }, pagination: { el: '.swiper-pagination', clickable: true } });
            } else { UI.bannerContainer.style.display = 'none'; }
            
            let homeHTML = '', liveTvPageHTML = '', cricketHTML = '', moviesHTML = '';
            const allItemsPromises = [];

            const tvPromise = getDocs(query(collection(db, "liveTV"), orderBy("order"))).then(tvSnapshot => {
                const tvGridItems = tvSnapshot.docs.map(doc => {
                    const item = { id: doc.id, ...doc.data() };
                    App.allContent.push({ title: item.name, posterUrl: item.logoUrl, link: `liveTV/${item.id}` });
                    return `<a href="#" data-id="liveTV/${item.id}" class="live-tv-channel content-link"><img src="${item.logoUrl}" alt="${item.name}"/></a>`;
                }).join('');
                liveTvPageHTML = Render.liveTvSection(tvGridItems);
                
                const tvHorizontalItems = tvSnapshot.docs.map(doc => Render.liveTvChannelCard({ id: doc.id, ...doc.data() })).join('');
                homeHTML += `<section class="space-y-4"><div class="section-title-wrapper"><div class="section-title"><span class="accent-bar"></span><h2>Live TV</h2></div><button class="see-more-btn text-xs font-semibold text-gray-400 hover:text-[var(--primary-color)]" data-type="livetv-redirect">View All <i class="fas fa-angle-right ml-1"></i></button></div><div class="flex overflow-x-auto gap-4 pb-2 scrollbar-hide -mx-4 px-4">${tvHorizontalItems}</div></section>`;
            });
            allItemsPromises.push(tvPromise);

            for (const type of ['cricket', 'movies']) {
                const sectionsPromise = getDocs(query(collection(db, `${type}Sections`), orderBy("order"))).then(async sectionsSnapshot => {
                    let generatedHtml = '';
                    for (const sectionDoc of sectionsSnapshot.docs) {
                        const sectionData = sectionDoc.data();

                        const itemsSnapshot = await getDocs(query(collection(db, `${type}Sections/${sectionDoc.id}/items`), orderBy("order", "asc")));
                        
                        if (itemsSnapshot.empty) continue;
                        
                        const itemsHTML = itemsSnapshot.docs.slice(0, 10).map(itemDoc => {
                            const itemData = { ...itemDoc.data(), link: `${type}Sections/${sectionDoc.id}/items/${itemDoc.id}` };
                            App.allContent.push(itemData);
                            return Render.card(itemData, type === 'cricket' ? 'thumbnail' : 'poster');
                        }).join('');
                        
                        const sectionHTML = Render.section(sectionData, itemsHTML, type, sectionDoc.id);
                        generatedHtml += sectionHTML;
                    }
                    if (type === 'cricket') cricketHTML = generatedHtml;
                    else moviesHTML = generatedHtml;
                });
                allItemsPromises.push(sectionsPromise);
            }

            await Promise.all(allItemsPromises);
            
            homeHTML += cricketHTML + moviesHTML;
            document.getElementById('home-sections-container').innerHTML = homeHTML;
            document.getElementById('livetv-page').innerHTML = liveTvPageHTML;
            document.getElementById('cricket-page').innerHTML = cricketHTML;
            document.getElementById('movies-page').innerHTML = moviesHTML;
        },
        init() {
            Drawer.init();
            App.switchPage('home-page');
            App.setupEventListeners();
            App.fetchAllContent();
        }
    };

    App.init();
</script>

</body>
</html>
