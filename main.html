<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Pro App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6a5af9; --primary-light: #f3f1ff;
            --secondary: #121212; --light-gray: #f1f3f6;
            --text-dark: #333; --text-light: #777;
            --white: #ffffff; --danger: #f76c6c;
        }

        body { background-color: var(--light-gray); font-family: 'Poppins', sans-serif; color: var(--text-dark); }

        #global-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--white); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .spinner { width: 56px; height: 56px; border-radius: 50%; border: 8px solid #f3f3f3; border-top: 8px solid var(--primary); animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); padding: 1rem; }
        .auth-form { background: var(--white); padding: 2.5rem; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); width: 100%; max-width: 400px; animation: fadeIn 0.5s ease; }
        .auth-form h3 { font-weight: 700; color: var(--secondary); }
        .form-control { border-radius: 10px; padding: 12px 15px; border: 1px solid #ddd; }
        .btn-main { background: var(--primary); color: var(--white); border-radius: 10px; padding: 12px; font-weight: 600; transition: all 0.3s ease; }
        .btn-main:hover { background: #5a48e3; transform: translateY(-2px); }

        .app-header { background: var(--white); color: var(--secondary); padding: 1rem 1.5rem; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .app-header .brand { font-weight: 700; font-size: 1.5rem; }

        .main-content { padding: 20px 15px 100px 15px; }
        .view { display: none; }
        .view.active { display: block; animation: slideUp 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--white); box-shadow: 0 -5px 20px rgba(0,0,0,0.08); display: flex; justify-content: space-around; padding: 10px 0; border-top-left-radius: 25px; border-top-right-radius: 25px; }
        .bottom-nav-link { color: var(--text-light); text-decoration: none; display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; font-weight: 500; transition: all 0.3s ease; }
        .bottom-nav-link i { font-size: 1.5rem; margin-bottom: 2px; }
        .bottom-nav-link.active { color: var(--primary); transform: translateY(-5px); }
        
        .card-style { background: var(--white); padding: 1.5rem; border-radius: 15px; margin-bottom: 1rem; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .balance-card { background: linear-gradient(45deg, var(--primary), #897bfc); color: var(--white); }
        .balance-card h4 { font-size: 1rem; opacity: 0.8; }
        .balance-card .balance-amount { font-size: 2.5rem; font-weight: 700; }
        
        .thumbnail-card { background: var(--white); border-radius: 15px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.05); transition: transform 0.3s ease; }
        .thumbnail-card:hover { transform: translateY(-5px); }
        .thumbnail-card img { width: 100%; height: 140px; object-fit: cover; }
        .thumbnail-card p { padding: 12px; margin: 0; font-weight: 600; }
        
        .profile-actions .btn { display: flex; align-items: center; padding: 1rem; margin-bottom: 0.8rem; border: none; background: var(--primary-light); color: var(--secondary); font-weight: 600; border-radius: 12px; }
        .profile-actions .btn i { font-size: 1.2rem; margin-right: 1rem; color: var(--primary); width: 25px; text-align: center; }
        .profile-actions .btn-danger { background: #fff1f1; color: var(--danger); }
        .profile-actions .btn-danger i { color: var(--danger); }
        
        .feature-locked { position: relative; }
        .feature-locked::after { content: 'Verify to Unlock'; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.85); color: var(--primary); font-weight: 700; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); border-radius: 15px; cursor: pointer; }

        .toast-notification { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 10px; color: var(--white); font-weight: 500; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 10000; opacity: 0; transform: translateY(-20px); transition: all 0.4s ease; }
        .toast-notification.show { opacity: 1; transform: translateY(0); }
        .toast-notification.success { background-color: #28a745; }
        .toast-notification.error { background-color: var(--danger); }

        .modal-content { border-radius: 20px !important; border: none !important; }
        .modal-header, .modal-footer { border: none !important; }

    </style>
</head>
<body>
    <div id="global-loader"><div class="spinner"></div></div>
    <div id="toast-notification" class="toast-notification"></div>

    <div class="auth-container" id="auth-container" style="display: none;">
        <div class="auth-form">
            <div id="login-view">
                <h3 class="text-center mb-4">Welcome Back</h3>
                <form id="login-form">
                    <div class="mb-3"><input type="email" class="form-control" id="login-email" placeholder="Email" required></div>
                    <div class="mb-3"><input type="password" class="form-control" id="login-password" placeholder="Password" required></div>
                    <button type="submit" class="btn btn-main w-100">Login</button>
                </form>
                <p class="mt-3 text-center">No account? <a href="#" id="show-signup" class="fw-bold text-decoration-none">Sign Up</a></p>
            </div>
            <div id="signup-view" style="display: none;">
                <h3 class="text-center mb-4">Create Account</h3>
                <form id="signup-form">
                    <div class="mb-3"><input type="text" class="form-control" id="signup-name" placeholder="Full Name" required></div>
                    <div class="mb-3"><input type="email" class="form-control" id="signup-email" placeholder="Email" required></div>
                    <div class="mb-3"><input type="password" class="form-control" id="signup-password" placeholder="Password" required></div>
                    <button type="submit" class="btn btn-main w-100">Sign Up</button>
                </form>
                <p class="mt-3 text-center">Have an account? <a href="#" id="show-login" class="fw-bold text-decoration-none">Login</a></p>
            </div>
        </div>
    </div>

    <div id="app-container" style="display: none;">
        <header class="app-header d-flex justify-content-between align-items-center">
            <span class="brand">Test - Emon</span>
            <a href="#" class="text-secondary fs-4"><i class="fas fa-bell"></i></a>
        </header>

        <main class="main-content">
            <div id="home-view" class="view"><div class="row g-3" id="home-content-grid"></div></div>
            <div id="referral-view" class="view">
                <div class="card-style" id="referral-section">
                    <h4>Your Code</h4>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="user-referral-code" readonly>
                        <button class="btn btn-primary" type="button" id="copy-referral-btn"><i class="fas fa-copy"></i></button>
                    </div>
                    <hr>
                    <h4>Use a Code</h4>
                    <p class="text-muted small">Enter a friend's code to get ৳50 bonus!</p>
                    <form id="referral-submit-form">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Enter code here" id="referral-code-input" required>
                            <button class="btn btn-primary" type="submit">Submit</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="profile-view" class="view">
                <div id="verification-notice" class="alert alert-warning text-center" style="display: none;">
                    Account not verified. <a href="#" data-bs-toggle="modal" data-bs-target="#verifyModal" class="fw-bold">Verify Now!</a>
                </div>
                <div class="card-style balance-card text-center mb-4">
                    <h4>Current Balance</h4>
                    <p id="user-balance" class="balance-amount">৳0.00</p>
                </div>
                <div class="card-style">
                    <h6>Account Info</h6>
                    <p class="mb-1 small"><strong>Name:</strong> <span id="user-name-display"></span></p>
                    <p class="small m-0"><strong>Email:</strong> <span id="user-email-display"></span></p>
                </div>
                <div class="card-style profile-actions">
                    <button class="btn" id="micro-jobs-btn"><i class="fas fa-tasks"></i> Micro Jobs</button>
                    <button class="btn" id="withdraw-btn" data-bs-toggle="modal" data-bs-target="#withdrawModal"><i class="fas fa-hand-holding-usd"></i> Withdraw Funds</button>
                    <button class="btn btn-danger" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </div>
        </main>
        
        <nav class="bottom-nav">
            <a href="#" class="bottom-nav-link active" data-view="home-view"><i class="fas fa-home"></i><span>Home</span></a>
            <a href="#" class="bottom-nav-link" data-view="referral-view"><i class="fas fa-user-friends"></i><span>Referral</span></a>
            <a href="#" class="bottom-nav-link" data-view="profile-view"><i class="fas fa-user"></i><span>Profile</span></a>
        </nav>
    </div>

    <div class="modal fade" id="verifyModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-2"><div class="modal-header"><h5 class="modal-title fw-bold">Account Verification</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Send <strong>৳50</strong> to bKash: <strong class="text-primary">01XXXXXXXXX</strong></p><form id="verify-form"><div class="mb-3"><input type="text" class="form-control" id="transaction-id" placeholder="Transaction ID" required></div><button type="submit" class="btn btn-main w-100">Submit for Verification</button></form></div></div></div></div>
    <div class="modal fade" id="withdrawModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-2"><div class="modal-header"><h5 class="modal-title fw-bold">Withdraw Funds</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Balance: <strong id="withdraw-balance-display">৳0.00</strong></p><p class="text-muted small">Min. withdrawal: ৳100.</p><form id="withdraw-form"><div class="mb-3"><select class="form-select" id="withdraw-method" required><option value="bKash">bKash</option><option value="Nagad">Nagad</option></select></div><div class="mb-3"><input type="text" class="form-control" id="withdraw-number" placeholder="Account Number" required></div><div class="mb-3"><input type="number" class="form-control" id="withdraw-amount" placeholder="Amount (BDT)" min="100" required></div><button type="submit" class="btn btn-main w-100">Request Withdrawal</button></form></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, update, push, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyAb8YsPMOY53GxiycCL6G0MPZdgWe3nnyY", authDomain: "movie-92659.firebaseapp.com", databaseURL: "https://movie-92659-default-rtdb.firebaseio.com", projectId: "movie-92659", storageBucket: "movie-92659.firebasestorage.app", messagingSenderId: "1090734362509", appId: "1:1090734362509:web:86be5583f6e8fcfdfa77c4", measurementId: "G-XF1TEP0DSJ" };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        let currentUserData = null;

        const loader = document.getElementById('global-loader');
        const showToast = (message, type = 'success') => {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.className = `toast-notification ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        };

        const showView = (viewId) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            document.querySelectorAll('.bottom-nav-link').forEach(l => {
                l.classList.toggle('active', l.dataset.view === viewId);
            });
        };
        
        onAuthStateChanged(auth, user => {
            if (user) {
                const userRef = ref(db, 'users/' + user.uid);
                onValue(userRef, (snapshot) => {
                    if (snapshot.exists()) {
                        currentUserData = { uid: user.uid, ...snapshot.val() };
                        updateUI(currentUserData);
                    }
                    document.getElementById('auth-container').style.display = 'none';
                    document.getElementById('app-container').style.display = 'block';
                    showView('home-view');
                    loader.style.display = 'none';
                });
                loadHomeContent();
            } else {
                document.getElementById('auth-container').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
                loader.style.display = 'none';
            }
        });

        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                const code = name.split(' ')[0].toUpperCase() + Math.random().toString(36).substr(2, 4).toUpperCase();
                await set(ref(db, 'users/' + cred.user.uid), { name, email, balance: 0, isVerified: false, referralCode: code, createdAt: serverTimestamp() });
                await set(ref(db, `referralCodes/${code}`), { userId: cred.user.uid });
            } catch (error) { showToast(error.message, 'error'); }
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value)
            .catch(error => showToast(error.message, 'error'));
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        document.getElementById('show-signup').addEventListener('click', e => { e.preventDefault(); document.getElementById('login-view').style.display = 'none'; document.getElementById('signup-view').style.display = 'block'; });
        document.getElementById('show-login').addEventListener('click', e => { e.preventDefault(); document.getElementById('signup-view').style.display = 'none'; document.getElementById('login-view').style.display = 'block'; });

        function updateUI(data) {
            document.getElementById('user-name-display').textContent = data.name;
            document.getElementById('user-email-display').textContent = data.email;
            document.getElementById('user-balance').textContent = `৳${(data.balance || 0).toFixed(2)}`;
            document.getElementById('withdraw-balance-display').textContent = `৳${(data.balance || 0).toFixed(2)}`;
            document.getElementById('user-referral-code').value = data.referralCode;

            const notice = document.getElementById('verification-notice');
            const referralSection = document.getElementById('referral-section');
            if (data.isVerified) {
                notice.style.display = 'none';
                referralSection.classList.remove('feature-locked');
            } else {
                notice.style.display = 'block';
                referralSection.classList.add('feature-locked');
            }
        }

        document.querySelectorAll('.bottom-nav-link').forEach(link => {
            link.addEventListener('click', (e) => { e.preventDefault(); showView(link.dataset.view); });
        });

        function loadHomeContent() {
            onValue(ref(db, 'homeContent'), (snapshot) => {
                const grid = document.getElementById('home-content-grid');
                grid.innerHTML = '';
                if(snapshot.exists()) {
                    snapshot.forEach(child => {
                        const c = child.val();
                        grid.innerHTML += `<div class="col-6"><a href="${c.targetUrl}" target="_blank" class="text-decoration-none text-dark"><div class="thumbnail-card"><img src="${c.imageUrl}"><p>${c.title}</p></div></a></div>`;
                    });
                } else { grid.innerHTML = '<p>No content available.</p>'; }
            });
        }
        
        document.getElementById('verify-form').addEventListener('submit', async e => {
            e.preventDefault();
            const trxId = document.getElementById('transaction-id').value;
            try {
                await push(ref(db, 'verificationRequests'), { userId: currentUserData.uid, userName: currentUserData.name, transactionId: trxId, status: 'pending', timestamp: serverTimestamp() });
                showToast('Verification request submitted!');
                bootstrap.Modal.getInstance(document.getElementById('verifyModal')).hide();
                e.target.reset();
            } catch (error) { showToast(error.message, 'error'); }
        });

        document.getElementById('copy-referral-btn').addEventListener('click', () => { navigator.clipboard.writeText(document.getElementById('user-referral-code').value).then(() => showToast('Code copied!')); });
        
        document.getElementById('referral-submit-form').addEventListener('submit', async e => {
            e.preventDefault();
            if (!currentUserData.isVerified) { showToast('Please verify your account first.', 'error'); return; }
            if (currentUserData.referredBy) { showToast('You have already used a referral code.', 'error'); return; }
            const code = document.getElementById('referral-code-input').value.trim().toUpperCase();
            if (code === currentUserData.referralCode) { showToast("You can't use your own code.", 'error'); return; }
            const snapshot = await get(ref(db, `referralCodes/${code}`));
            if(snapshot.exists()){
                const referrerId = snapshot.val().userId;
                try {
                    await runTransaction(ref(db, `users/${currentUserData.uid}`), (d) => { if (d) { d.balance += 50; d.referredBy = referrerId; } return d; });
                    await runTransaction(ref(db, `users/${referrerId}`), (d) => { if (d) { d.balance = (d.balance || 0) + 25; } return d; });
                    showToast('Success! You got a ৳50 bonus!'); e.target.reset();
                } catch(error) { showToast(error.message, 'error'); }
            } else { showToast('Invalid referral code.', 'error'); }
        });

        document.getElementById('withdraw-form').addEventListener('submit', async e => {
            e.preventDefault();
            if (!currentUserData.isVerified) { showToast('Please verify your account to withdraw.', 'error'); return; }
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            if (amount < 100) { showToast('Minimum withdrawal is ৳100.', 'error'); return; }
            if (amount > currentUserData.balance) { showToast('Insufficient balance.', 'error'); return; }
            
            try {
                await update(ref(db, `users/${currentUserData.uid}`), { balance: currentUserData.balance - amount });
                await push(ref(db, 'withdrawalRequests'), { userId: currentUserData.uid, userName: currentUserData.name, amount, method: document.getElementById('withdraw-method').value, accountNumber: document.getElementById('withdraw-number').value, status: 'pending', timestamp: serverTimestamp() });
                showToast('Withdrawal request submitted!');
                bootstrap.Modal.getInstance(document.getElementById('withdrawModal')).hide(); e.target.reset();
            } catch (error) { showToast(error.message, 'error'); }
        });
    </script>
</body>
</html>
